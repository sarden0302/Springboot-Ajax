<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <link rel="icon" href="/favicon.ico">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<h1 class="container">피자 수정하기</h1>
<form id="edit-form" class="edit-form">
    <label for="name">이름:</label>
    <input type="text" id="name" name="name" required>

    <label for="price">가격:</label>
    <input type="number" id="price" name="price" required>

    <label for="description">상세 정보:</label>
    <input type="text" id="description" name="description" required>


    <label for="imagePath">이미지:</label>
    <input type="file" id="imagePath" name="imagePath" required>

    <div class="image-preview-container">
        <div class="image-preview" id="imagePreview">
            <span>미리보기 이미지가 여기에 표시됩니다.</span>
        </div>
    </div>

    <button type="submit" class="btn">수정 완료</button>
</form>


<script>
    $(document).ready(function() {
        const pizzaId = new URLSearchParams(window.location.search).get("id");
        console.log(pizzaId);

        $.ajax({
            url : `/api/pizza/${pizzaId}`,
            method : 'GET',
            success: function (pizza) {
                if (!pizza) {
                    alert("no data!");
                    window.location.href = "pizzas";
                    return;
                }
                $('#name').val(pizza.name);
                $('#price').val(pizza.price);
                $('#description').val(pizza.description);
                $('#imagePath').val(pizza.imagePath);
            }
        })

        $('#imagePath').change(function (event) {
            const file = event.target.files[0];
            $('#preview').html('');

            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function (e){
                    console.log("reader.result : ", e.target.result);
                    $('#imagePreview').append($('<img>').attr({
                        "src": e.target.result,
                        "alt" : "미리보기 이미지",
                        "maxWidth" : "100%",
                        "maxHeight" : "300px"
                    }));
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = "<span>지원하지 않는 파일 형식입니다.</span>";
            }
        })

        $("#edit-form").on("submit", function (event) {
            event.preventDefault();

            let formData = new FormData();
            formData.append("name", $('#name').val());
            formData.append("price", $('#price').val());
            formData.append("description", $('#description').val());
            formData.append("imagePath", $('#imagePath')[0].files[0]);

            $.ajax({
                url: `/api/pizza/edit/${pizzaId}`,
                method: 'PUT',
                contentType: false,
                processData: false,
                data: formData,
                success: function (data) {
                    alert(data + "개 수정");
                    window.location.href = `/pizzas/detail?id=${pizzaId}`;
                },
                error : function (error) {
                    alert("피자 수정 중 에러 발생!");
                }


            })
        })



    })
</script>
</body>
</html>